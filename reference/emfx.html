<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Post-estimation aggregation of ETWFE results — emfx • etwfe</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Post-estimation aggregation of ETWFE results — emfx"><meta name="description" content="Companion function to etwfe, enabling the recovery of aggregate treatment
effects along different dimensions of interest (e.g, an event study of
dynamic average treatment effects). emfx is a light wrapper around the
slopes function from the marginaleffects
package."><meta property="og:description" content="Companion function to etwfe, enabling the recovery of aggregate treatment
effects along different dimensions of interest (e.g, an event study of
dynamic average treatment effects). emfx is a light wrapper around the
slopes function from the marginaleffects
package."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">etwfe</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5.0.99</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/etwfe.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/grantmcdermott/etwfe/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Post-estimation aggregation of ETWFE results</h1>
      <small class="dont-index">Source: <a href="https://github.com/grantmcdermott/etwfe/blob/main/R/emfx.R" class="external-link"><code>R/emfx.R</code></a></small>
      <div class="d-none name"><code>emfx.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Companion function to <code>etwfe</code>, enabling the recovery of aggregate treatment
effects along different dimensions of interest (e.g, an event study of
dynamic average treatment effects). <code>emfx</code> is a light wrapper around the
<code><a href="https://marginaleffects.com/man/r/slopes.html" class="external-link">slopes</a></code> function from the <strong>marginaleffects</strong>
package.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">emfx</span><span class="op">(</span></span>
<span>  <span class="va">object</span>,</span>
<span>  type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"simple"</span>, <span class="st">"group"</span>, <span class="st">"calendar"</span>, <span class="st">"event"</span><span class="op">)</span>,</span>
<span>  by_xvar <span class="op">=</span> <span class="st">"auto"</span>,</span>
<span>  compress <span class="op">=</span> <span class="st">"auto"</span>,</span>
<span>  collapse <span class="op">=</span> <span class="va">compress</span>,</span>
<span>  predict <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"response"</span>, <span class="st">"link"</span><span class="op">)</span>,</span>
<span>  post_only <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  lean <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-object">object<a class="anchor" aria-label="anchor" href="#arg-object"></a></dt>
<dd><p>An <code>etwfe</code> model object.</p></dd>


<dt id="arg-type">type<a class="anchor" aria-label="anchor" href="#arg-type"></a></dt>
<dd><p>Character. The desired type of post-estimation aggregation.</p></dd>


<dt id="arg-by-xvar">by_xvar<a class="anchor" aria-label="anchor" href="#arg-by-xvar"></a></dt>
<dd><p>Logical. Should the results account for heterogeneous
treatment effects? Only relevant if the preceding <code>etwfe</code> call included a
specified <code>xvar</code> argument, i.e. interacted categorical covariate. The
default behaviour (<code>"auto"</code>) is to automatically estimate heterogeneous
treatment effects for each level of <code>xvar</code> if these are detected as part
of the underlying <code>etwfe</code> model object. Users can override by setting to
either <code>FALSE</code> or <code>TRUE.</code> See the "Heterogeneous treatment effects"
section below.</p></dd>


<dt id="arg-compress">compress<a class="anchor" aria-label="anchor" href="#arg-compress"></a></dt>
<dd><p>Logical. Compress the data by (period by cohort) groups
before calculating marginal effects? This trades off a slight loss in
precision (typically around the 1st or 2nd significant decimal point) for a
substantial improvement in estimation time for large datasets. The default
behaviour (<code>"auto"</code>) is to automatically compress if the original dataset
has more than 500,000 rows. Users can override by setting either <code>FALSE</code> or
<code>TRUE</code>. Note that collapsing by group is only valid if the preceding <code>etwfe</code>
call was run with <code>"ivar = NULL"</code> (the default). See the "Performance
tips" section below.</p></dd>


<dt id="arg-collapse">collapse<a class="anchor" aria-label="anchor" href="#arg-collapse"></a></dt>
<dd><p>Logical. An alias for <code>compress</code> (only used for backwards
compatability and ignored if both arguments are provided). The behaviour is
identical, but it will trigger a message nudging users to rather use the
<code>compress</code> argument.</p></dd>


<dt id="arg-predict">predict<a class="anchor" aria-label="anchor" href="#arg-predict"></a></dt>
<dd><p>Character. The type (scale) of prediction used to compute the
marginal effects. If <code>"response"</code> (the default), then the output is at the
level of the response variable, i.e. it is the expected predictor
\(E(Y|X)\). If <code>"link"</code>, the value returned is the linear predictor of
the fitted model, i.e. \(X\cdot \beta\). The difference should only
matter for nonlinear models. (Note: This argument is typically called
<code>type</code> when use in <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></code> or
<code><a href="https://marginaleffects.com/man/r/slopes.html" class="external-link">slopes</a></code>, but we rename it here to avoid a
clash with the top-level <code>type</code> argument above.)</p></dd>


<dt id="arg-post-only">post_only<a class="anchor" aria-label="anchor" href="#arg-post-only"></a></dt>
<dd><p>Logical. Drop pre-treatment ATTs? Only evaluated if (a)
<code>type = "event"</code> and (b) the original <code>etwfe</code> model object was estimated
using the default <code>"notyet"</code> treated control group. If conditions (a) and
(b) are met then the pre-treatment effects will be zero as a mechanical
result of ETWFE's estimation setup. The default behaviour (<code>TRUE</code>) is
thus to drop these nuisance rows from the dataset. The <code>post_only</code> argument
recognises that you may still want to keep them for presentation purposes
(e.g., plotting an event study). Nevertheless, be forewarned that enabling
that behaviour via <code>FALSE</code> is <em>strictly</em> performative: the "zero" treatment
effects for any pre-treatment periods is purely an artefact of the
estimation setup.</p></dd>


<dt id="arg-lean">lean<a class="anchor" aria-label="anchor" href="#arg-lean"></a></dt>
<dd><p>Logical. Default is <code>FALSE</code>. Switching to <code>TRUE</code> enforces a lean
return object; namely a simple data.frame of the main results, stripped of
ancillary attributes. Note that this will disable some advanced
<code>marginaleffects</code> post-processing features, but those are unlikely to be
used in the <code>emfx</code> context. The upside is a potentially dramatic reduction
in the size of the return object. Consequently, we may change the default
to <code>TRUE</code> in a future version of <strong>etwfe</strong>.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Additional arguments passed to
<code><a href="https://marginaleffects.com/man/r/slopes.html" class="external-link">marginaleffects::slopes</a></code>. For example, you can pass <code>vcov = FALSE</code>
to dramatically speed up estimation times of the main marginal
effects (but at the cost of not getting any information about standard
errors; see Performance tips below). Another potentially useful
application is testing whether heterogeneous treatment effects (i.e., the
levels of any <code>xvar</code> covariate) are equal by invoking the <code>hypothesis</code>
argument, e.g. <code>hypothesis = "b1 = b2"</code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A <code>data.frame</code> of aggregated treatment effects along the
dimension(s) of interested. Note that this data.frame will have been
overloaded with the <code><a href="https://marginaleffects.com/man/r/slopes.html" class="external-link">slopes</a></code> class, and so
will come with a special print method. But the underlying columns will
usually include:</p><ul><li><p><code>term</code></p></li>
<li><p><code>contrast</code></p></li>
<li><p><code>&lt;type&gt;</code> (i.e., the name of your <code>type</code> string)</p></li>
<li><p><code>estimate</code></p></li>
<li><p><code>std.error</code></p></li>
<li><p><code>statistic</code></p></li>
<li><p><code>p.value</code></p></li>
<li><p><code>s.value</code></p></li>
<li><p><code>conf.low</code></p></li>
<li><p><code>conf.high</code></p></li>
</ul></div>
    <div class="section level2">
    <h2 id="performance-tips">Performance tips<a class="anchor" aria-label="anchor" href="#performance-tips"></a></h2>



<p>Under most situations, <code>etwfe</code> should complete very quickly. For its part,
<code>emfx</code> is quite performant too and should take a few seconds or less for
datasets under 100k rows. However, <code>emfx</code>'s computation time does tend to
scale non-linearly with the size of the original data, as well as the
number of interactions from the underlying <code>etwfe</code> model. Without getting
too deep into the weeds, the numerical delta method used to recover the
ATEs of interest has to estimate two prediction models for <em>each</em>
coefficient in the model and then compute their standard errors. So, it's
a potentially expensive operation that can push the computation time for
large datasets (&gt; 1m rows) up to several minutes or longer.</p>
<p>Fortunately, there are two complementary strategies that you can use to
speed things up. The first is to turn off the most expensive part of the
whole procedure—standard error calculation—by calling <code>emfx(..., vcov = FALSE)</code>. Doing so should bring the estimation time back down to a few
seconds or less, even for datasets in excess of a million rows. While the
loss of standard errors might not be an acceptable trade-off for projects
where statistical inference is critical, the good news is this first
strategy can still be combined our second strategy. It turns out that
collapsing the data by groups prior to estimating the marginal effects can
yield substantial speed gains of its own. Users can do this by invoking
the <code>emfx(..., collapse = TRUE)</code> argument. While the effect here is not as
dramatic as the first strategy, our second strategy does have the virtue
of retaining information about the standard errors. The trade-off this
time, however, is that collapsing our data does lead to a loss in accuracy
for our estimated parameters. On the other hand, testing suggests that
this loss in accuracy tends to be relatively minor, with results
equivalent up to the 1st or 2nd significant decimal place (or even
better).</p>
<p>Summarizing, here's a quick plan of attack for you to try if you are
worried about the estimation time for large datasets and models:</p><ol><li><p>Estimate <code>mod = etwfe(...)</code> as per usual.</p></li>
<li><p>Run <code>emfx(mod, vcov = FALSE, ...)</code>.</p></li>
<li><p>Run <code>emfx(mod, vcov = FALSE, collapse = TRUE, ...)</code>.</p></li>
<li><p>Compare the point estimates from steps 1 and 2. If they are are similar
enough to your satisfaction, get the approximate standard errors by
running <code>emfx(mod, collapse = TRUE, ...)</code>.</p></li>
</ol></div>
    <div class="section level2">
    <h2 id="heterogeneous-treatment-effects">Heterogeneous treatment effects<a class="anchor" aria-label="anchor" href="#heterogeneous-treatment-effects"></a></h2>



<p>Specifying <code>etwfe(..., xvar = &lt;xvar&gt;)</code> will generate interaction effects
for all levels of <code>&lt;xvar&gt;</code> as part of the main regression model. The
reason that this is useful (as opposed to a regular, non-interacted
covariate in the formula RHS) is that it allows us to estimate
heterogeneous treatment effects as part of the larger ETWFE framework.
Specifically, we can recover heterogeneous treatment effects for each
level of <code>&lt;xvar&gt;</code> by passing the resulting <code>etwfe</code> model object on to
<code>emfx()</code>.</p>
<p>For example, imagine that we have a categorical variable called "age" in
our dataset, with two distinct levels "adult" and "child". Running
<code>emfx(etwfe(..., xvar = age))</code> will tell us how the efficacy of treatment
varies across adults and children. We can then also leverage the in-built
hypothesis testing infrastructure of <code>marginaleffects</code> to test whether
the treatment effect is statistically different across these two age
groups; see Examples below. Note the same principles carry over to
categorical variables with multiple levels, or even continuous variables
(although continuous variables are not as well supported yet).</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Wong, Jeffrey <em>et al.</em> (2021). <cite>You Only Compress Once: Optimal Data
Compression for Estimating Linear Models</cite>. Working paper (version: March 16,
2021). Available:
https://doi.org/10.48550/arXiv.2102.11297</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><a href="https://marginaleffects.com/man/r/slopes.html" class="external-link">marginaleffects::slopes</a> which does the heavily lifting behind the
scenes. <code><a href="etwfe.html">etwfe</a></code> is the companion estimating function that should be run
before <code>emfx</code>.</p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># We’ll use the mpdta dataset from the did package (which you’ll need to </span></span></span>
<span class="r-in"><span><span class="co"># install separately).</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># install.packages("did")</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"mpdta"</span>, package <span class="op">=</span> <span class="st">"did"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span><span class="co"># Basic example</span></span></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># The basic ETWFE workflow involves two consecutive function calls:</span></span></span>
<span class="r-in"><span><span class="co"># 1) `etwfe` and 2) `emfx`</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># 1) `etwfe`: Estimate a regression model with saturated interaction terms.</span></span></span>
<span class="r-in"><span><span class="va">mod</span> <span class="op">=</span> <span class="fu"><a href="etwfe.html">etwfe</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  fml  <span class="op">=</span> <span class="va">lemp</span> <span class="op">~</span> <span class="va">lpop</span>, <span class="co"># outcome ~ controls (use 0 or 1 if none)</span></span></span>
<span class="r-in"><span>  tvar <span class="op">=</span> <span class="va">year</span>,        <span class="co"># time variable</span></span></span>
<span class="r-in"><span>  gvar <span class="op">=</span> <span class="va">first.treat</span>, <span class="co"># group variable</span></span></span>
<span class="r-in"><span>  data <span class="op">=</span> <span class="va">mpdta</span>,       <span class="co"># dataset</span></span></span>
<span class="r-in"><span>  vcov <span class="op">=</span> <span class="op">~</span><span class="va">countyreal</span>  <span class="co"># vcov adjustment (here: clustered by county)</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># mod ## A fixest model object with fully saturated interaction effects.</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># 2) `emfx`: Recover the treatment effects of interest.</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="op">(</span><span class="va">mod_es</span> <span class="op">=</span> <span class="fu">emfx</span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">"event"</span><span class="op">)</span><span class="op">)</span> <span class="co"># dynamic ATE a la an event study</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  event Estimate Std. Error     z Pr(&gt;|z|)    S   2.5 %   97.5 %</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      0  -0.0332     0.0134 -2.48    0.013  6.3 -0.0594 -0.00702</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      1  -0.0573     0.0171 -3.34   &lt;0.001 10.2 -0.0910 -0.02373</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      2  -0.1379     0.0308 -4.48   &lt;0.001 17.0 -0.1982 -0.07753</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      3  -0.1095     0.0323 -3.39   &lt;0.001 10.5 -0.1729 -0.04620</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Term: .Dtreat</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Type: response</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Comparison: TRUE - FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Etc. Other aggregation type options are "simple" (the default), "group"</span></span></span>
<span class="r-in"><span><span class="co"># and "calendar"</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># To visualize results, use the native plot method (see `?plot.emfx`)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod_es</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="emfx-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Notice that we don't get any pre-treatment effects with the default</span></span></span>
<span class="r-in"><span><span class="co"># "notyet" treated control group. Switch to the "never" treated control</span></span></span>
<span class="r-in"><span><span class="co"># group if you want this.</span></span></span>
<span class="r-in"><span><span class="fu"><a href="etwfe.html">etwfe</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">lemp</span> <span class="op">~</span> <span class="va">lpop</span>, tvar <span class="op">=</span> <span class="va">year</span>, gvar <span class="op">=</span> <span class="va">first.treat</span>, data <span class="op">=</span> <span class="va">mpdta</span>,</span></span>
<span class="r-in"><span>  vcov <span class="op">=</span> <span class="op">~</span><span class="va">countyreal</span>,</span></span>
<span class="r-in"><span>  cgroup <span class="op">=</span> <span class="st">"never"</span>    <span class="co">## &lt;= use never treated group as control</span></span></span>
<span class="r-in"><span>  <span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">emfx</span><span class="op">(</span><span class="st">"event"</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="emfx-2.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span><span class="co"># Heterogeneous treatment effects</span></span></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example where we estimate heterogeneous treatment effects for counties </span></span></span>
<span class="r-in"><span><span class="co"># within the 8 US Great Lake states (versus all other counties). </span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">gls</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"IL"</span> <span class="op">=</span> <span class="fl">17</span>, <span class="st">"IN"</span> <span class="op">=</span> <span class="fl">18</span>, <span class="st">"MI"</span> <span class="op">=</span> <span class="fl">26</span>, <span class="st">"MN"</span> <span class="op">=</span> <span class="fl">27</span>,</span></span>
<span class="r-in"><span>        <span class="st">"NY"</span> <span class="op">=</span> <span class="fl">36</span>, <span class="st">"OH"</span> <span class="op">=</span> <span class="fl">39</span>, <span class="st">"PA"</span> <span class="op">=</span> <span class="fl">42</span>, <span class="st">"WI"</span> <span class="op">=</span> <span class="fl">55</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">mpdta</span><span class="op">$</span><span class="va">gls</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">mpdta</span><span class="op">$</span><span class="va">countyreal</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">gls</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">hmod</span> <span class="op">=</span> <span class="fu"><a href="etwfe.html">etwfe</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">lemp</span> <span class="op">~</span> <span class="va">lpop</span>, tvar <span class="op">=</span> <span class="va">year</span>, gvar <span class="op">=</span> <span class="va">first.treat</span>, data <span class="op">=</span> <span class="va">mpdta</span>, </span></span>
<span class="r-in"><span>  vcov <span class="op">=</span> <span class="op">~</span><span class="va">countyreal</span>,</span></span>
<span class="r-in"><span>  xvar <span class="op">=</span> <span class="va">gls</span>           <span class="co">## &lt;= het. TEs by gls</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Heterogeneous ATEs (could also specify "event", etc.) </span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu">emfx</span><span class="op">(</span><span class="va">hmod</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  .Dtreat   gls Estimate Std. Error     z Pr(&gt;|z|)   S  2.5 %  97.5 %</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     TRUE FALSE  -0.0637     0.0376 -1.69   0.0905 3.5 -0.137 0.01005</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     TRUE  TRUE  -0.0472     0.0271 -1.74   0.0816 3.6 -0.100 0.00593</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Term: .Dtreat</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Type: response</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Comparison: TRUE - FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># To test whether the ATEs across these two groups (non-GLS vs GLS) are </span></span></span>
<span class="r-in"><span><span class="co"># statistically different, simply pass an appropriate "hypothesis" argument.</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu">emfx</span><span class="op">(</span><span class="va">hmod</span>, hypothesis <span class="op">=</span> <span class="st">"b1 = b2"</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> It is essential to check the order of estimates when specifying hypothesis tests using positional indices like b1, b2, etc. The indices of estimates can change depending on the order of rows in the original dataset, user-supplied arguments, model-fitting package, and version of `marginaleffects`.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> </span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> It is also good practice to use assertions that ensure the order of estimates is consistent across different runs of the same code. Example:</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> </span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> ```r</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> mod &lt;- lm(mpg ~ am * carb, data = mtcars)</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> </span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> # assertion for safety</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> p &lt;- avg_predictions(mod, by = 'carb')</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> stopifnot(p$carb[1] != 1 || p$carb[2] != 2)</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> </span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> # hypothesis test</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> avg_predictions(mod, by = 'carb', hypothesis = 'b1 - b2 = 0')</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> ```</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> </span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> Disable this warning with: `options(marginaleffects_safe = FALSE)`</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span>  This warning appears once per session.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  Hypothesis Estimate Std. Error      z Pr(&gt;|z|)   S  2.5 % 97.5 %</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       b1=b2  -0.0164     0.0558 -0.294    0.768 0.4 -0.126  0.093</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Type: response</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">emfx</span><span class="op">(</span><span class="va">hmod</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="emfx-3.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span><span class="co"># Nonlinear model (distribution / link) families</span></span></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Poisson example</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">mpdta</span><span class="op">$</span><span class="va">emp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">mpdta</span><span class="op">$</span><span class="va">lemp</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="etwfe.html">etwfe</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">emp</span> <span class="op">~</span> <span class="va">lpop</span>, tvar <span class="op">=</span> <span class="va">year</span>, gvar <span class="op">=</span> <span class="va">first.treat</span>, data <span class="op">=</span> <span class="va">mpdta</span>, </span></span>
<span class="r-in"><span>  vcov <span class="op">=</span> <span class="op">~</span><span class="va">countyreal</span>,</span></span>
<span class="r-in"><span>  family <span class="op">=</span> <span class="st">"poisson"</span>   <span class="co">## &lt;= family arg for nonlinear options</span></span></span>
<span class="r-in"><span>  <span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">emfx</span><span class="op">(</span><span class="st">"event"</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The variables '.Dtreat:first.treat::2006:year::2004', '.Dtreat:first.treat::2006:year::2005', '.Dtreat:first.treat::2007:year::2004', '.Dtreat:first.treat::2007:year::2005', '.Dtreat:first.treat::2007:year::2006', '.Dtreat:first.treat::2006:year::2004:lpop_dm' and 4 others have been removed because of collinearity (see $collin.var).</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  event Estimate Std. Error       z Pr(&gt;|z|)    S  2.5 % 97.5 %</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      0   -25.35       15.9 -1.5957  0.11056  3.2  -56.5   5.79</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      1     1.09       40.3  0.0271  0.97838  0.0  -77.9  80.07</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      2   -75.12       23.2 -3.2445  0.00118  9.7 -120.5 -29.74</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      3  -101.82       27.1 -3.7590  &lt; 0.001 12.5 -154.9 -48.73</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Term: .Dtreat</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Type: response</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Comparison: TRUE - FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span><span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Grant McDermott.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

